@using Tourism.ViewModel
@model ProductViewModel
@using System.Security.Claims
@{
    Layout = "EcommerceLayout";
}

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">

    <link rel="stylesheet" href="~/css/Ecommerce.css" />
</head>
<body>

    <!-- Product Detail Section -->
    <section class="product-detail-section">
        <div class="container">
            <div class="row">
                <!-- Product Images -->
                <div class="col-md-5">
                    <div class="product-image-container">
                        @if (Model.UploadedImages != null && Model.UploadedImages.Any())
                        {
                            using (var ms = new MemoryStream())
                            {
                                Model.UploadedImages[0].CopyTo(ms);
                                var bytes = ms.ToArray();
                                <img id="mainImage" class="main-image" src="data:image/jpeg;base64,@Convert.ToBase64String(bytes)" alt="@Model.name" />
                            }

                            if (Model.UploadedImages.Count > 1)
                            {
                                <div class="thumbnail-container">
                                    @for (int i = 0; i < Model.UploadedImages.Count; i++)
                                    {
                                        using (var ms = new MemoryStream())
                                        {
                                            Model.UploadedImages[i].CopyTo(ms);
                                            var bytes = ms.ToArray();
                                            var base64 = Convert.ToBase64String(bytes);
                                            <img class="thumbnail @(i == 0 ? "active" : "")"
                                                 src="data:image/jpeg;base64,@base64"
                                                 alt="@Model.name thumbnail @(i+1)"
                                                 onclick="changeMainImage(this)" />
                                        }
                                    }
                                </div>
                            }
                        }
                        else
                        {
                            <img id="mainImage" class="main-image" src="@Url.Content("~/pics/placeholder.jpg")" alt="@Model.name" />
                        }
                    </div>
                </div>

                <!-- Product Info -->
                <div class="col-md-7">
                    <div class="product-info-container">
                        <h1 class="product-title">@Model.name</h1>

                        @if (!string.IsNullOrEmpty(Model.MerchantName))
                        {
                            <p class="merchant-name">Sold by: <span>@Model.MerchantName</span></p>
                        }

                        <!-- Rating -->
                        <div class="rating-display">
                            @for (int i = 1; i <= 5; i++)
                            {
                                if (i <= Model.rate)
                                {
                                    <span>★</span>
                                }
                                else
                                {
                                    <span style="color:#ccc;">★</span>
                                }
                            }
                            <span>(@Model.rate.ToString("0.0") / 5.0)</span>
                        </div>

                        <!-- Price -->
                        <div class="price-section">
                            @if (Model.offer > 0)
                            {
                                var discountedPrice = Model.price - (Model.price * Model.offer / 100.0);
                                <span class="current-price">$@discountedPrice.ToString("0.00")</span>
                                <span class="original-price">$@Model.price.ToString("0.00")</span>
                                <span class="offer-badge">@Model.offer% OFF</span>
                            }
                            else
                            {
                                <span class="current-price">$@Model.price.ToString("0.00")</span>
                            }
                        </div>

                        <!-- Description -->
                        <div class="product-description">
                            <h5 style="color: #003D5B; font-weight: 600;">Description</h5>
                            <p>@Model.description</p>
                        </div>

                        <!-- Delivery Info -->
                        @if (Model.deliveryDate.HasValue)
                        {
                            <div class="delivery-info">
                                <strong>Delivery Date:</strong> @Model.deliveryDate.Value.ToString("MMMM dd, yyyy")
                            </div>
                        }

                        <!-- Action Buttons -->
                        <div class="action-buttons d-flex gap-2 mt-3">
                            <!-- Add to Cart -->
                            <button type="button" class="btn btn-add-cart" id="btnAddToCart" data-product-id="@Model.productId">
                                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="currentColor" class="bi bi-cart" viewBox="0 0 16 16">
                                    <path d="M0 1.5A.5.5 0 0 1 .5 1h1a.5.5 0 0 1 .485.379L2.89 5H14.5a.5.5 0 0 1 .49.598l-1.5 7A.5.5 0 0 1 13 13H4a.5.5 0 0
                                        1-.491-.408L1.01 2H.5a.5.5 0 0
                                        1-.5-.5zM3.14 6l1.25 5h8.22l1.25-5H3.14zM5.5
                                        12a1 1 0 1 0 0 2 1 1 0 0 0
                                        0-2zm6 0a1 1 0 1 0 0 2 1
                                        1 0 0 0 0-2z" />
                                </svg>
                                Add to Cart
                            </button>

                            <!-- Buy Now -->
                            <form asp-action="ProceedToCheckout" asp-controller="Tourist" method="post" id="purchaseForm">
                                <input type="hidden" name="purchaseData[0].productId" value="@Model.productId" />
                                <input type="hidden" name="purchaseData[0].count" value="@Model.count" />
                                <input type="hidden" name="purchaseData[0].price"
                                       value="@(Model.price - (Model.price * Model.offer / 100.0))" />
                                <input type="hidden" name="purchaseData[0].DeliversWithin" value="@Model.DeliversWithin" />

                                <button type="submit" class="btn btn-buy-now" id="checkout-btn">Buy Now</button>
                            </form>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Reviews Section -->
            <div class="row mt-4">
                <div class="col-12">
                    <div class="reviews-section">
                        <h2 class="reviews-title">Customer Reviews</h2>

                        <!-- Add Review Form -->
                        <div class="add-review-section">
                            <h3 class="add-review-title">Write a Review</h3>
                            <form asp-action="SubmitReview" method="post">
                                <div class="mb-3">
                                    <label class="form-label fw-bold">Rating</label>
                                    <div class="star-rating-input">
                                        <input type="radio" id="star5" name="rating" value="5" />
                                        <label for="star5">★</label>
                                        <input type="radio" id="star4" name="rating" value="4" />
                                        <label for="star4">★</label>
                                        <input type="radio" id="star3" name="rating" value="3" />
                                        <label for="star3">★</label>
                                        <input type="radio" id="star2" name="rating" value="2" />
                                        <label for="star2">★</label>
                                        <input type="radio" id="star1" name="rating" value="1" />
                                        <label for="star1">★</label>
                                    </div>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label fw-bold">Comment</label>
                                    <textarea class="form-control" name="comment" rows="4" placeholder="Share your experience with this product..." required></textarea>
                                </div>
                                <button type="submit" class="btn btn-submit-review">Send Review</button>
                            </form>
                        </div>

                        <!-- Display Reviews -->
                        @if (Model.Reviews != null && Model.Reviews.Any())
                        {
                            foreach (var review in Model.Reviews)
                            {
                                <div class="review-card">
                                    <div class="review-rating">
                                        @for (int i = 1; i <= 5; i++)
                                        {
                                            if (i <= review.Rating)
                                            {
                                                <span>★</span>
                                            }
                                            else
                                            {
                                                <span style="color:#ccc;">★</span>
                                            }
                                        }
                                    </div>
                                    <p class="review-comment">@review.Comment</p>
                                    <p class="review-date">Posted on @review.CreatedAt.ToString("MMMM dd, yyyy")</p>
                                </div>
                            }
                        }
                        else
                        {
                            <div class="no-reviews">
                                <p>No reviews yet. Be the first to review this product!</p>
                            </div>
                        }
                    </div>
                </div>
            </div>
        </div>
    </section>

    <script>
        function changeMainImage(thumbnail) {
            const mainImage = document.getElementById('mainImage');
            mainImage.src = thumbnail.src;
            document.querySelectorAll('.thumbnail').forEach(thumb => thumb.classList.remove('active'));
            thumbnail.classList.add('active');
        }

        
        document.addEventListener("DOMContentLoaded", () => {
            const btn = document.getElementById("btnAddToCart");
            if (!btn) return;

            btn.addEventListener("click", async () => {
                const productId = btn.dataset.productId;

                try {
                    const response = await fetch("/Tourist/AddToCart", {
                        method: "POST",
                        headers: {
                            "Content-Type": "application/x-www-form-urlencoded"
                        },
                        body: `productId=${productId}`
                    });

                    if (response.ok) {
                        btn.textContent = "Added ✓";
                        btn.disabled = true;
                        btn.style.backgroundColor = "#198754"; // green
                        btn.style.color = "white";
                    } else if (response.status === 401) {
                        alert("Please log in first.");
                    } else {
                        alert("This product could not be added to the cart.");
                    }
                } catch (error) {
                    console.error("Error adding to cart:", error);
                    alert("Something went wrong. Try again later.");
                }
            });
        });
    </script>
</body>
</html>
